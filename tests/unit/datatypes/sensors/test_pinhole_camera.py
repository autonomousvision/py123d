import numpy as np
import pytest

from py123d.datatypes.sensors.pinhole_camera import (
    PinholeCamera,
    PinholeCameraMetadata,
    PinholeCameraType,
    PinholeDistortion,
    PinholeDistortionIndex,
    PinholeIntrinsics,
)
from py123d.geometry import PoseSE3


class TestPinholeCameraType:
    def test_camera_type_values(self):
        """Test that camera type enum has expected values."""
        assert PinholeCameraType.PCAM_F0 == PinholeCameraType.PCAM_F0
        assert PinholeCameraType.PCAM_B0 == PinholeCameraType.PCAM_B0
        assert PinholeCameraType.PCAM_L0 == PinholeCameraType.PCAM_L0
        assert PinholeCameraType.PCAM_L1 == PinholeCameraType.PCAM_L1
        assert PinholeCameraType.PCAM_L2 == PinholeCameraType.PCAM_L2
        assert PinholeCameraType.PCAM_R0 == PinholeCameraType.PCAM_R0
        assert PinholeCameraType.PCAM_R1 == PinholeCameraType.PCAM_R1
        assert PinholeCameraType.PCAM_R2 == PinholeCameraType.PCAM_R2
        assert PinholeCameraType.PCAM_STEREO_L == PinholeCameraType.PCAM_STEREO_L
        assert PinholeCameraType.PCAM_STEREO_R == PinholeCameraType.PCAM_STEREO_R

    def test_camera_type_from_int(self):
        """Test creating camera type from integer."""
        assert PinholeCameraType(0) == PinholeCameraType.PCAM_F0
        assert PinholeCameraType(5) == PinholeCameraType.PCAM_R0
        assert PinholeCameraType(9) == PinholeCameraType.PCAM_STEREO_R

    def test_camera_type_count(self):
        """Test that all camera types are defined."""
        camera_types = list(PinholeCameraType)
        assert len(camera_types) == 10

    def test_camera_type_unique_values(self):
        """Test that all camera type values are unique."""
        values = [ct.value for ct in PinholeCameraType]
        assert len(values) == len(set(values))


class TestPinholeIntrinsics:
    def test_intrinsics_creation(self):
        """Test creating PinholeIntrinsics instance."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0, skew=0.0)

        assert intrinsics.fx == 500.0
        assert intrinsics.fy == 500.0
        assert intrinsics.cx == 320.0
        assert intrinsics.cy == 240.0
        assert intrinsics.skew == 0.0

    def test_intrinsics_default_skew(self):
        """Test that skew defaults to 0.0 when not provided."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)

        assert intrinsics.skew == 0.0

    def test_intrinsics_from_array(self):
        """Test creating intrinsics from array."""
        array = np.array([500.0, 500.0, 320.0, 240.0, 0.0], dtype=np.float64)
        intrinsics = PinholeIntrinsics.from_array(array)

        assert intrinsics.fx == 500.0
        assert intrinsics.fy == 500.0
        assert intrinsics.cx == 320.0
        assert intrinsics.cy == 240.0
        assert intrinsics.skew == 0.0

    def test_intrinsics_from_array_copy(self):
        """Test that from_array creates a copy by default."""
        array = np.array([500.0, 500.0, 320.0, 240.0, 0.0], dtype=np.float64)
        intrinsics = PinholeIntrinsics.from_array(array, copy=True)

        # Modify original array
        array[0] = 1000.0

        # Intrinsics should still have original value
        assert intrinsics.fx == 500.0

    def test_intrinsics_from_array_no_copy(self):
        """Test that from_array can avoid copying."""
        array = np.array([500.0, 500.0, 320.0, 240.0, 0.0], dtype=np.float64)
        intrinsics = PinholeIntrinsics.from_array(array, copy=False)

        # Modify original array
        array[0] = 1000.0

        # Intrinsics should reflect the change
        assert intrinsics.fx == 1000.0

    def test_intrinsics_from_camera_matrix(self):
        """Test creating intrinsics from 3x3 camera matrix."""
        K = np.array([[500.0, 0.5, 320.0], [0.0, 500.0, 240.0], [0.0, 0.0, 1.0]], dtype=np.float64)

        intrinsics = PinholeIntrinsics.from_camera_matrix(K)

        assert intrinsics.fx == 500.0
        assert intrinsics.fy == 500.0
        assert intrinsics.cx == 320.0
        assert intrinsics.cy == 240.0
        assert intrinsics.skew == 0.5

    def test_intrinsics_camera_matrix_property(self):
        """Test getting camera matrix from intrinsics."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=600.0, cx=320.0, cy=240.0, skew=0.5)
        K = intrinsics.camera_matrix

        expected_K = np.array([[500.0, 0.5, 320.0], [0.0, 600.0, 240.0], [0.0, 0.0, 1.0]], dtype=np.float64)

        np.testing.assert_array_almost_equal(K, expected_K)

    def test_intrinsics_camera_matrix_roundtrip(self):
        """Test converting to camera matrix and back."""
        original_K = np.array([[500.0, 0.5, 320.0], [0.0, 600.0, 240.0], [0.0, 0.0, 1.0]], dtype=np.float64)

        intrinsics = PinholeIntrinsics.from_camera_matrix(original_K)
        restored_K = intrinsics.camera_matrix

        np.testing.assert_array_almost_equal(restored_K, original_K)

    def test_intrinsics_array_property(self):
        """Test accessing the underlying array."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0, skew=0.5)
        array = intrinsics.array

        assert isinstance(array, np.ndarray)
        assert array.shape == (5,)
        np.testing.assert_array_almost_equal(array, [500.0, 500.0, 320.0, 240.0, 0.5])

    def test_intrinsics_from_list(self):
        """Test creating intrinsics from list via from_list method."""
        intrinsics_list = [500.0, 500.0, 320.0, 240.0, 0.0]
        intrinsics = PinholeIntrinsics.from_list(intrinsics_list)

        assert intrinsics.fx == 500.0
        assert intrinsics.fy == 500.0
        assert intrinsics.cx == 320.0
        assert intrinsics.cy == 240.0
        assert intrinsics.skew == 0.0

    def test_intrinsics_tolist(self):
        """Test converting intrinsics to list."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0, skew=0.5)
        intrinsics_list = intrinsics.tolist()

        assert isinstance(intrinsics_list, list)
        assert len(intrinsics_list) == 5
        assert intrinsics_list[0] == pytest.approx(500.0)
        assert intrinsics_list[1] == pytest.approx(500.0)
        assert intrinsics_list[2] == pytest.approx(320.0)
        assert intrinsics_list[3] == pytest.approx(240.0)
        assert intrinsics_list[4] == pytest.approx(0.5)

    def test_intrinsics_different_fx_fy(self):
        """Test intrinsics with different focal lengths."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=600.0, cx=320.0, cy=240.0)

        assert intrinsics.fx == 500.0
        assert intrinsics.fy == 600.0
        assert intrinsics.fx != intrinsics.fy

    def test_intrinsics_non_centered_principal_point(self):
        """Test intrinsics with non-centered principal point."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=100.0, cy=100.0)

        assert intrinsics.cx == 100.0
        assert intrinsics.cy == 100.0


class TestPinholeDistortion:
    def test_distortion_creation(self):
        """Test creating PinholeDistortion instance."""
        distortion = PinholeDistortion(k1=0.1, k2=0.01, p1=0.001, p2=0.001, k3=0.001)

        assert distortion.k1 == 0.1
        assert distortion.k2 == 0.01
        assert distortion.p1 == 0.001
        assert distortion.p2 == 0.001
        assert distortion.k3 == 0.001

    def test_distortion_from_array(self):
        """Test creating distortion from array."""
        array = np.array([0.1, 0.01, 0.001, 0.001, 0.001], dtype=np.float64)
        distortion = PinholeDistortion.from_array(array)

        assert distortion.k1 == 0.1
        assert distortion.k2 == 0.01
        assert distortion.p1 == 0.001
        assert distortion.p2 == 0.001
        assert distortion.k3 == 0.001

    def test_distortion_from_array_copy(self):
        """Test that from_array creates a copy by default."""
        array = np.array([0.1, 0.01, 0.001, 0.001, 0.001], dtype=np.float64)
        distortion = PinholeDistortion.from_array(array, copy=True)

        # Modify original array
        array[0] = 0.5

        # Distortion should still have original value
        assert distortion.k1 == 0.1

    def test_distortion_from_array_no_copy(self):
        """Test that from_array can avoid copying."""
        array = np.array([0.1, 0.01, 0.001, 0.001, 0.001], dtype=np.float64)
        distortion = PinholeDistortion.from_array(array, copy=False)

        # Modify original array
        array[0] = 0.5

        # Distortion should reflect the change
        assert distortion.k1 == 0.5

    def test_distortion_array_property(self):
        """Test accessing the underlying array."""
        distortion = PinholeDistortion(k1=0.1, k2=0.01, p1=0.001, p2=0.001, k3=0.001)
        array = distortion.array

        assert isinstance(array, np.ndarray)
        assert array.shape == (len(PinholeDistortionIndex),)
        np.testing.assert_array_almost_equal(array, [0.1, 0.01, 0.001, 0.001, 0.001])

    def test_distortion_zero_values(self):
        """Test distortion with zero values."""
        distortion = PinholeDistortion(k1=0.0, k2=0.0, p1=0.0, p2=0.0, k3=0.0)

        assert distortion.k1 == 0.0
        assert distortion.k2 == 0.0
        assert distortion.p1 == 0.0
        assert distortion.p2 == 0.0
        assert distortion.k3 == 0.0

    def test_distortion_negative_values(self):
        """Test distortion with negative values."""
        distortion = PinholeDistortion(k1=-0.1, k2=-0.01, p1=-0.001, p2=-0.001, k3=-0.001)

        assert distortion.k1 == -0.1
        assert distortion.k2 == -0.01
        assert distortion.p1 == -0.001
        assert distortion.p2 == -0.001
        assert distortion.k3 == -0.001

    def test_distortion_from_list(self):
        """Test creating distortion from list via from_list method."""
        distortion_list = [0.1, 0.01, 0.001, 0.001, 0.001]
        distortion = PinholeDistortion.from_list(distortion_list)

        assert distortion.k1 == 0.1
        assert distortion.k2 == 0.01
        assert distortion.p1 == 0.001
        assert distortion.p2 == 0.001
        assert distortion.k3 == 0.001

    def test_distortion_tolist(self):
        """Test converting distortion to list."""
        distortion = PinholeDistortion(k1=0.1, k2=0.01, p1=0.001, p2=0.001, k3=0.001)
        distortion_list = distortion.tolist()

        assert isinstance(distortion_list, list)
        assert len(distortion_list) == 5
        assert distortion_list[0] == pytest.approx(0.1)
        assert distortion_list[1] == pytest.approx(0.01)
        assert distortion_list[2] == pytest.approx(0.001)
        assert distortion_list[3] == pytest.approx(0.001)
        assert distortion_list[4] == pytest.approx(0.001)


class TestPinholeMetadata:
    def test_metadata_from_dict_with_none_intrinsics(self):
        """Test creating metadata from dict with None intrinsics."""
        data_dict = {
            "camera_type": 1,
            "intrinsics": None,
            "distortion": [0.1, 0.01, 0.001, 0.001, 0.001],
            "width": 800,
            "height": 600,
        }

        metadata = PinholeCameraMetadata.from_dict(data_dict)

        assert metadata.camera_type == PinholeCameraType.PCAM_B0
        assert metadata.intrinsics is None
        assert metadata.distortion is not None
        assert metadata.width == 800
        assert metadata.height == 600

    def test_metadata_from_dict_with_none_distortion(self):
        """Test creating metadata from dict with None distortion."""
        data_dict = {
            "camera_type": 2,
            "intrinsics": [600.0, 600.0, 400.0, 300.0, 0.0],
            "distortion": None,
            "width": 800,
            "height": 600,
        }

        metadata = PinholeCameraMetadata.from_dict(data_dict)

        assert metadata.camera_type == PinholeCameraType.PCAM_L0
        assert metadata.intrinsics is not None
        assert metadata.distortion is None

    def test_metadata_different_aspect_ratios(self):
        """Test metadata with different aspect ratios."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)

        # 16:9 aspect ratio
        metadata_16_9 = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics, distortion=None, width=1920, height=1080
        )
        assert metadata_16_9.aspect_ratio == pytest.approx(16 / 9)

        # 4:3 aspect ratio
        metadata_4_3 = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics, distortion=None, width=640, height=480
        )
        assert metadata_4_3.aspect_ratio == pytest.approx(4 / 3)

    def test_metadata_fov_with_different_focal_lengths(self):
        """Test FOV calculation with different focal lengths."""
        intrinsics_narrow = PinholeIntrinsics(fx=1000.0, fy=1000.0, cx=320.0, cy=240.0)
        intrinsics_wide = PinholeIntrinsics(fx=250.0, fy=250.0, cx=320.0, cy=240.0)

        metadata_narrow = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics_narrow, distortion=None, width=640, height=480
        )
        metadata_wide = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics_wide, distortion=None, width=640, height=480
        )

        # Wider focal length should result in larger FOV
        assert metadata_wide.fov_x > metadata_narrow.fov_x
        assert metadata_wide.fov_y > metadata_narrow.fov_y

    def test_metadata_to_dict_preserves_types(self):
        """Test that to_dict preserves correct types."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)
        distortion = PinholeDistortion(k1=0.1, k2=0.01, p1=0.001, p2=0.001, k3=0.001)

        metadata = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_R1, intrinsics=intrinsics, distortion=distortion, width=1280, height=720
        )

        data_dict = metadata.to_dict()

        assert isinstance(data_dict["camera_type"], int)
        assert isinstance(data_dict["width"], int)
        assert isinstance(data_dict["height"], int)
        assert isinstance(data_dict["intrinsics"], list)
        assert isinstance(data_dict["distortion"], list)

    def test_metadata_all_camera_types(self):
        """Test metadata creation with all camera types."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)

        for camera_type in PinholeCameraType:
            metadata = PinholeCameraMetadata(
                camera_type=camera_type, intrinsics=intrinsics, distortion=None, width=640, height=480
            )
            assert metadata.camera_type == camera_type

    def test_metadata_square_image(self):
        """Test metadata with square image dimensions."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=256.0, cy=256.0)
        metadata = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics, distortion=None, width=512, height=512
        )

        assert metadata.aspect_ratio == 1.0
        assert metadata.fov_x == pytest.approx(metadata.fov_y)

    def test_metadata_non_square_pixels(self):
        """Test metadata with non-square pixels (different fx and fy)."""
        intrinsics = PinholeIntrinsics(fx=500.0, fy=600.0, cx=320.0, cy=240.0)
        metadata = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics, distortion=None, width=640, height=480
        )

        expected_fov_x = 2 * np.arctan(640 / (2 * 500.0))
        expected_fov_y = 2 * np.arctan(480 / (2 * 600.0))

        assert metadata.fov_x == pytest.approx(expected_fov_x)
        assert metadata.fov_y == pytest.approx(expected_fov_y)
        assert metadata.fov_x != pytest.approx(metadata.fov_y)


class TestPinholeCamera:
    def test_pinhole_camera_creation(self):
        """Test creating PinholeCamera instance."""

        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)
        metadata = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics, distortion=None, width=640, height=480
        )
        image = np.zeros((480, 640, 3), dtype=np.uint8)
        extrinsic = PoseSE3(x=0.0, y=0.0, z=0.0, qw=1.0, qx=0.0, qy=0.0, qz=0.0)

        camera = PinholeCamera(metadata=metadata, image=image, extrinsic=extrinsic)

        assert camera.metadata == metadata
        assert np.array_equal(camera.image, image)
        assert camera.extrinsic == extrinsic

    def test_pinhole_camera_with_color_image(self):
        """Test PinholeCamera with color image."""

        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)
        metadata = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0, intrinsics=intrinsics, distortion=None, width=640, height=480
        )
        image = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
        extrinsic = PoseSE3(x=0.0, y=0.0, z=0.0, qw=1.0, qx=0.0, qy=0.0, qz=0.0)

        camera = PinholeCamera(metadata=metadata, image=image, extrinsic=extrinsic)

        assert camera.image.shape == (480, 640, 3)
        assert camera.image.dtype == np.uint8

    def test_pinhole_camera_with_grayscale_image(self):
        """Test PinholeCamera with grayscale image."""

        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)
        metadata = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_L0, intrinsics=intrinsics, distortion=None, width=640, height=480
        )
        image = np.random.randint(0, 255, (480, 640), dtype=np.uint8)
        extrinsic = PoseSE3(x=0.0, y=0.0, z=0.0, qw=1.0, qx=0.0, qy=0.0, qz=0.0)

        camera = PinholeCamera(metadata=metadata, image=image, extrinsic=extrinsic)

        assert camera.image.shape == (480, 640)

    def test_pinhole_camera_with_distortion(self):
        """Test PinholeCamera with distortion parameters."""

        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)
        distortion = PinholeDistortion(k1=0.1, k2=0.01, p1=0.001, p2=0.001, k3=0.001)
        metadata = PinholeCameraMetadata(
            camera_type=PinholeCameraType.PCAM_F0,
            intrinsics=intrinsics,
            distortion=distortion,
            width=640,
            height=480,
        )
        image = np.zeros((480, 640, 3), dtype=np.uint8)
        extrinsic = PoseSE3(x=0.0, y=0.0, z=0.0, qw=1.0, qx=0.0, qy=0.0, qz=0.0)

        camera = PinholeCamera(metadata=metadata, image=image, extrinsic=extrinsic)

        assert camera.metadata.distortion is not None
        assert camera.metadata.distortion.k1 == 0.1

    def test_pinhole_camera_different_types(self):
        """Test PinholeCamera with different camera types."""

        intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=320.0, cy=240.0)
        image = np.zeros((480, 640, 3), dtype=np.uint8)
        extrinsic = PoseSE3(x=0.0, y=0.0, z=0.0, qw=1.0, qx=0.0, qy=0.0, qz=0.0)

        for camera_type in [
            PinholeCameraType.PCAM_F0,
            PinholeCameraType.PCAM_B0,
            PinholeCameraType.PCAM_STEREO_L,
            PinholeCameraType.PCAM_STEREO_R,
        ]:
            metadata = PinholeCameraMetadata(
                camera_type=camera_type, intrinsics=intrinsics, distortion=None, width=640, height=480
            )
            camera = PinholeCamera(metadata=metadata, image=image, extrinsic=extrinsic)
            assert camera.metadata.camera_type == camera_type

    def test_pinhole_camera_with_different_resolutions(self):
        """Test PinholeCamera with different image resolutions."""

        resolutions = [(640, 480), (1920, 1080), (1280, 720), (800, 600)]
        extrinsic = PoseSE3(x=0.0, y=0.0, z=0.0, qw=1.0, qx=0.0, qy=0.0, qz=0.0)

        for width, height in resolutions:
            intrinsics = PinholeIntrinsics(fx=500.0, fy=500.0, cx=width / 2, cy=height / 2)
            metadata = PinholeCameraMetadata(
                camera_type=PinholeCameraType.PCAM_F0,
                intrinsics=intrinsics,
                distortion=None,
                width=width,
                height=height,
            )
            image = np.zeros((height, width, 3), dtype=np.uint8)
            camera = PinholeCamera(metadata=metadata, image=image, extrinsic=extrinsic)

            assert camera.metadata.width == width
            assert camera.metadata.height == height
            assert camera.image.shape[:2] == (height, width)
